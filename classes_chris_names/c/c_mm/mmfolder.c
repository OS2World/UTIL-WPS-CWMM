
/*
 *  This file was generated by the SOM Compiler and Emitter Framework.
 *  Generated using: 
 *      SOM Emitter emitctm: 2.42
 */

#ifndef SOM_Module_mmfolder_Source
#define SOM_Module_mmfolder_Source
#endif
#define MMFolder_Class_Source
#define M_MMFolder_Class_Source

#define INCL_GPIBITMAPS
#define INCL_PM
#include <os2.h>
#include <stdio.h>
#include "helpid.h"
#include "mmfolder.ih"
/* Include file with definition for WPShadow class */
#include "wpshadow.h"
#include "cwimage.h"
#include "cwmmres.h"
#include "cwbmp.h"
#include "cwaudioinc.h"
#ifndef  _cwmmQuerySmallBitmapHandle
#define _cwmmQuerySmallBitmapHandle CWImage_cwmmQuerySmallBitmapHandle
#define _cwmmQuerySmallBitmapHandleCWBitmap CWBitmap_cwmmQuerySmallBitmapHandle
#endif

#define STOREWINDOWID 112233

void writeLog(const char* chrFormat, ...);
BOOL getMessage(char* text,ULONG ulID, LONG lSizeText, HMODULE hResource,HWND hwnd);
HMODULE queryModuleHandle(void);
MRESULT HlpInsertMenuItem(int iPosition, HWND hwndMenu, HWND hwndSubMenu, int iID, char * chrText);
MRESULT HlpInsertMenuSeparator(int iPosition, HWND hwndMenu, HWND hwndSubMenu);

WPObject* cwGetFileSystemObject(WPObject* wpObject);

static SOMClass * queryWpFolderClass(void)
{
  somId mySomId;
  static SOMClass * mWPFolderClass=NULLHANDLE;

  if(!mWPFolderClass) {
    if((mySomId=somIdFromString("WPFolder"))!=NULLHANDLE) {
      mWPFolderClass=(SOMClass*)_somClassFromId(SOMClassMgrObject, mySomId);
      SOMFree(mySomId);
    }
  }
  return mWPFolderClass;
}

static SOMClass* queryCWImageFileClass(void)
{
  somId mySomId;
  static SOMClass *mWPImgClass=NULL;

  if(!mWPImgClass) {
    if((mySomId=somIdFromString("CWImage"))!=NULLHANDLE) {
      mWPImgClass=(SOMClass*)_somClassFromId(SOMClassMgrObject, mySomId);
      SOMFree(mySomId);
    }
  }
  return mWPImgClass;
}

static SOMClass* queryCWBitmapFileClass(void)
{
  somId mySomId;
  static SOMClass *mWPImgClass=NULL;

  if(!mWPImgClass) {
    if((mySomId=somIdFromString("CWBitmap"))!=NULLHANDLE) {
      mWPImgClass=(SOMClass*)_somClassFromId(SOMClassMgrObject, mySomId);
      SOMFree(mySomId);
    }
  }
  return mWPImgClass;
}


MRESULT EXPENTRY mmFolderContainerProc(HWND hwnd, ULONG msg, MPARAM mp1, MPARAM mp2) 
{
  HWND hwndStore;
  MMFolder *somSelf;

  //  writeLog("Msg: 0x%x, Mask: 0x%x\n", msg);
  switch(msg)
    {
    case CM_SETCNRINFO:
      {
        /* Make sure CNR stays ownerdrawn even when user changes view */
        PCNRINFO pCnrInfo=(PCNRINFO)PVOIDFROMMP(mp1);
        if(pCnrInfo) {

          //          writeLog("flWindowAttr: 0x%x, Mask: 0x%x\n", pCnrInfo->flWindowAttr, LONGFROMMP(mp2));
          if(!(pCnrInfo->flWindowAttr & (CV_DETAIL|CV_TREE/*|CV_ICON|CV_NAME*/)) &&
             (LONGFROMMP(mp2)&CMA_FLWINDOWATTR)) {
            HWND hwndFrame=WinQueryWindow(hwnd, QW_PARENT);
            //            DosBeep(5000, 500);
            //         writeLog("Accepted, flWindowAttr: 0x%x, Mask: 0x%x\n", pCnrInfo->flWindowAttr, LONGFROMMP(mp2));
            if((hwndStore=WinWindowFromID(hwndFrame, STOREWINDOWID))!=NULLHANDLE)
              {
                somSelf=(MMFolder*) WinQueryWindowULong(hwndStore,QWL_USER);
                if(somIsObj(somSelf)) {
                  MMFolderData *somThis = MMFolderGetData(somSelf); 
                  
                  //                  DosBeep(5000, 500);
                  pCnrInfo->flWindowAttr&=~CA_DRAWICON;
                  pCnrInfo->flWindowAttr|=CA_DRAWBITMAP|CA_OWNERDRAW;
                  pCnrInfo->slBitmapOrIcon.cx=_ulCurrentSize;
                  pCnrInfo->slBitmapOrIcon.cy=_ulCurrentSize;

                  mp2=MPFROMLONG(LONGFROMMP(mp2)|CMA_SLBITMAPORICON|CMA_FLWINDOWATTR);
                }
              }
          }
          else
            {
              //              DosBeep(500, 500);
              //      writeLog("Accepted, flWindowAttr: 0x%x, Mask: 0x%x\n", pCnrInfo->flWindowAttr, LONGFROMMP(mp2));
              if(pCnrInfo->flWindowAttr & (CV_DETAIL|CV_TREE)) {
                //        DosBeep(5000, 500);
                //  writeLog("Accepted, flWindowAttr: 0x%x, Mask: 0x%x\n", pCnrInfo->flWindowAttr, LONGFROMMP(mp2));
                pCnrInfo->flWindowAttr&=~(CA_OWNERDRAW|CA_DRAWBITMAP);
                pCnrInfo->flWindowAttr|=CA_DRAWICON;

                pCnrInfo->slBitmapOrIcon.cx=0;
                pCnrInfo->slBitmapOrIcon.cy=0;

                //        if(pCnrInfo->flWindowAttr & CV_TREE)
                  mp2=MPFROMLONG(LONGFROMMP(mp2)|CMA_SLBITMAPORICON);
                  //  mp2=MPFROMLONG(LONGFROMMP(mp2)|CMA_SLBITMAPORICON|CMA_FLWINDOWATTR);
                
#if 0
                pCnrInfo->flWindowAttr&=~CA_DRAWICON;
                pCnrInfo->flWindowAttr|=CA_DRAWBITMAP|CA_OWNERDRAW;
                pCnrInfo->slBitmapOrIcon.cx=0;
                pCnrInfo->slBitmapOrIcon.cy=0;
                mp2=MPFROMLONG(LONGFROMMP(mp2)|CMA_SLBITMAPORICON|CMA_FLWINDOWATTR);
#endif
              }
            }
        }
      break;
      }
    default:
      break;
    }
  /* Any other message is handled by the folder container procedure */
  if((hwndStore=WinQueryWindow(hwnd,QW_PARENT))!=NULLHANDLE)
    {
      if((hwndStore=WinWindowFromID(hwndStore, STOREWINDOWID))!=NULLHANDLE)
        {
          somSelf=(MMFolder*) WinQueryWindowULong(hwndStore,QWL_USER);
          if(somIsObj(somSelf)) {
            MMFolderData *somThis = MMFolderGetData(somSelf); 
            if(_oldContainerProc)
              return _oldContainerProc(hwnd, msg, mp1, mp2);
          }
        }
    }    
  return WinDefWindowProc(hwnd, msg, mp1, mp2);
}

//BOOL bNot;

/* This function draws a two coloured 1 pixel border. It's used to draw the outmost
   line of any 3D element like buttons. */
static BOOL cwDraw2ColorBorder(HPS hps, RECTL *rcl, ULONG color1, ULONG color2)
{
  //  PPOINTL pptl=(PPOINTL)rcl;
  POINTL ptl=*((PPOINTL)rcl);

  GpiMove(hps, &ptl);
  GpiSetColor(hps, color1);
  ptl.x=rcl->xRight;
  GpiLine(hps,&ptl);
  ptl.y=rcl->yTop;
  GpiLine(hps,&ptl);
  ptl.x-=1;
  GpiMove(hps, &ptl);
  GpiSetColor(hps, color2);
  ptl.x=rcl->xLeft;
  GpiLine(hps,&ptl);
  ptl.y=rcl->yBottom+1;
  GpiLine(hps,&ptl);
  return TRUE;
}


static void cwAdjustIconRECTL(RECTL * rcl, ULONG ulMaxIconWidth, ULONG ulWidthBMP, ULONG ulHeightBMP)
{

  if(!rcl)
    return;

  rcl->xLeft+=2;
  if(ulMaxIconWidth>ulWidthBMP)
    rcl->xLeft+=(ulMaxIconWidth-ulWidthBMP)/2;
  rcl->xRight=rcl->xLeft+ulWidthBMP;
  rcl->yBottom+=2;
  if(ulMaxIconWidth>ulHeightBMP)
    rcl->yBottom+=(ulMaxIconWidth-ulHeightBMP)/2;
  rcl->yTop=rcl->yBottom+ulHeightBMP;///ulFact;

}

MRESULT EXPENTRY mmFolderFrameProc(HWND hwnd, ULONG msg, MPARAM mp1, MPARAM mp2) 
{
  HWND hwndStore;
  MMFolder *somSelf;

  switch(msg)
    {
    case WM_DRAWITEM:
      {
        POWNERITEM pOwnerItem=(POWNERITEM)PVOIDFROMMP(mp2);

        /* We only draw icons not text */
        if(pOwnerItem->idItem==CMA_ICON /*&& !bNot*/) {
          PMINIRECORDCORE mrc=(PMINIRECORDCORE)((PCNRDRAWITEMINFO)pOwnerItem->hItem)->pRecord;
          RECTL rclTemp=pOwnerItem->rclItem;
          HWND hwndCnr=WinWindowFromID(hwnd, FID_CLIENT);
          PCNRDRAWITEMINFO pCnrDrawItemInfo=(PCNRDRAWITEMINFO)pOwnerItem->hItem;

          /*
            Draw emphasis if any. Otherwise draw white background.
           */
          rclTemp.xLeft+=2;
          rclTemp.xRight-=2;
          rclTemp.yBottom+=2;
          rclTemp.yTop-=2;
          
          /* Check if record is selected and in use */
          if((pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_INUSE)
             && (pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_SELECTED)) {
            POINTL pointl;

            WinFillRect(pOwnerItem->hps, &rclTemp, CLR_WHITE);            
            GpiSetPattern(pOwnerItem->hps,PATSYM_DIAG2);
            pointl.x = rclTemp.xLeft;
            pointl.y = rclTemp.yBottom;
            GpiMove(pOwnerItem->hps, &pointl);
            pointl.x = rclTemp.xRight - 1;
            pointl.y = rclTemp.yTop - 1;
            GpiSetColor(pOwnerItem->hps, CLR_BLACK);
            GpiBox(pOwnerItem->hps,DRO_FILL,&pointl,1,1);         
            
          }
          /* Check if record is in use */
          else if(pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_INUSE) {
            POINTL pointl;

            WinFillRect(pOwnerItem->hps, &rclTemp, CLR_WHITE);            
            GpiSetPattern(pOwnerItem->hps,PATSYM_DIAG1);
            pointl.x = rclTemp.xLeft;
            pointl.y = rclTemp.yBottom;
            GpiMove(pOwnerItem->hps, &pointl);
            pointl.x = rclTemp.xRight - 1;
            pointl.y = rclTemp.yTop - 1;
            GpiSetColor(pOwnerItem->hps, CLR_BLACK);
            GpiBox(pOwnerItem->hps,DRO_FILL,&pointl,1,1);                    
          }
          /* or is it only selected? */
          else if(pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_SELECTED)
            WinFillRect(pOwnerItem->hps, &rclTemp, CLR_DARKGRAY);
          /* Default is paint white background */
          else
            WinFillRect(pOwnerItem->hps, &rclTemp, CLR_WHITE);
          
          if(mrc){
            WPObject *wpObject;
            ULONG ulIconSize=150;/* Default if query fails */
            
            wpObject=(WPObject*)OBJECT_FROM_PREC(mrc);//Get object
            wpObject=cwGetFileSystemObject(wpObject);
            
            if(somIsObj(wpObject)) {
              SOMClass* cwBitmapClass=queryCWBitmapFileClass();
              SOMClass* cwImageClass=queryCWImageFileClass();
              
              if(somIsObj(cwImageClass)||somIsObj(cwBitmapClass)) {
                HBITMAP hbm=NULLHANDLE;
                PBITMAPINFOHEADER2 pBmpInfoHeader2;

                /* Get object pointer */                
                if((hwndStore=WinWindowFromID(hwnd, STOREWINDOWID))!=NULLHANDLE)
                  {
                    somSelf=(MMFolder*) WinQueryWindowULong(hwndStore,QWL_USER);
                    if(somIsObj(somSelf)) {
                      MMFolderData *somThis = MMFolderGetData(somSelf); 
                      ulIconSize=_ulCurrentSize;
                    }
                  }
                /* Get a small bitmap */
                if(_somIsA(wpObject, cwImageClass)) {
                  //  writeLog("FrameProc: mrc: 0x%x, hwndCnr: 0x%x\n", mrc, hwndCnr);
                  hbm=_cwmmQuerySmallBitmapHandle( (CWImage*) wpObject, ulIconSize, mrc, hwndCnr);
                  pBmpInfoHeader2=(PBITMAPINFOHEADER2)_wpQueryBitmapInfoHeader((CWImage*)wpObject);
                }
                else if(_somIsA(wpObject, cwBitmapClass)) {
                  /* The default WPS bitmap class returns an PBITMAPHEADER. The CWBitmap class
                     does return a PBITMAPHEADER2<-.  */
                  hbm=_cwmmQuerySmallBitmapHandleCWBitmap( (CWImage*) wpObject, ulIconSize);
                  pBmpInfoHeader2=(PBITMAPINFOHEADER2)_cwmmQueryBitmapInfoHeader((CWBitmap*)wpObject);
                }

                if(hbm)
                  {
                    /* We have the small bitmap */
                    if(pBmpInfoHeader2) {
                      ULONG ulWidth, ulHeight;
                      ULONG ulIconWidth;
                      ULONG ulFact;
                      RECTL rcl=pOwnerItem->rclItem;
                      if(pBmpInfoHeader2->cbFix==sizeof(BITMAPINFOHEADER2)) {
                        ulWidth=pBmpInfoHeader2->cx;
                        ulHeight=pBmpInfoHeader2->cy;
                      }
                      else {
                        PBITMAPINFOHEADER pBmpInfoHeader=(PBITMAPINFOHEADER)pBmpInfoHeader2;
                        ulWidth=pBmpInfoHeader->cx;
                        ulHeight=pBmpInfoHeader->cy;
                      }
                      ulIconWidth=rcl.xRight-rcl.xLeft-4;
                      // writeLog2("cbSize: %d w: %d h: %d, icon: %d\n", pBmpInfoHeader2->cbFix, ulWidth, ulHeight, ulIconWidth);
                      ulFact=ulWidth>ulHeight ? ulWidth*1000/ulIconWidth : ulHeight*1000/ulIconWidth;
                      ulWidth=ulWidth*1000/ulFact;
                      ulHeight=ulHeight*1000/ulFact;
                      //          writeLog2("ulFact: %d w: %d h: %d\n", ulFact, ulWidth, ulHeight);         
                      cwAdjustIconRECTL(&rcl, ulIconWidth, ulWidth, ulHeight);          
#if 0
                      rcl.xLeft+=2;
                      if(ulIconWidth>ulWidth)
                        rcl.xLeft+=(ulIconWidth-ulWidth)/2;
                      rcl.xRight=rcl.xLeft+ulWidth;///ulFact;
                      rcl.yBottom+=2;
                      if(ulIconWidth>ulHeight)
                        rcl.yBottom+=(ulIconWidth-ulHeight)/2;
                      rcl.yTop=rcl.yBottom+ulHeight;///ulFact;
#endif                 
                      /* And now draw the bitmap */
                      WinDrawBitmap(pOwnerItem->hps, hbm, NULL, (PPOINTL)&rcl,//pOwnerItem->rclItem,
                                    0,0,DBM_STRETCH);
                    }
                    //        WinDrawBorder(pOwnerItem->hps, &rclTemp, 3,3,0,0,0x400);
                    cwDraw2ColorBorder(pOwnerItem->hps, &rclTemp, CLR_BLACK, CLR_DARKGRAY);
                    //                    WinDrawBorder(pOwnerItem->hps, &rclTemp, 1,1,CLR_BLACK,0, 0);
                    return (MRESULT) TRUE;
                  }/* hbm */

              }/* cwImageClass */
            }/* wpObject*/
            /* It's not an image class. Draw normal pointer */
            if((ulIconSize=WinQuerySysValue(HWND_DESKTOP,SV_CXICON))!=0)
              {
                ULONG ulWidth=ulIconSize;
                ULONG ulHeight=ulIconSize;
                ULONG ulIconWidth;
                RECTL rcl=pOwnerItem->rclItem;
                
                ulIconWidth=rcl.xRight-rcl.xLeft-4;
                /* Move the icon into the middle of the drawing area */
                cwAdjustIconRECTL(&rcl, ulIconWidth, ulWidth, ulHeight);
#if 0
                rcl.xLeft+=2;
                if(ulIconWidth>ulWidth)
                  rcl.xLeft+=(ulIconWidth-ulWidth)/2;
                rcl.yBottom+=2;
                if(ulIconWidth>ulHeight)
                  rcl.yBottom+=(ulIconWidth-ulHeight)/2;
#endif 
#if 0
                /* Check for folder because of animated icon */
                if(somIsObj(wpObject)) {
                  SOMClass* wpFolderClass=queryWpFolderClass();
                  
                  if(somIsObj(wpFolderClass)) {
                    if(_somIsA(wpObject, wpFolderClass)) {   
                      /* It's a folder */
                      HPOINTER hptr;

                      pOwnerItem->rclItem.xLeft=rcl.xLeft;
                      pOwnerItem->rclItem.yBottom+=50;//rcl.yBottom;
                      WinFillRect(pOwnerItem->hps, &pOwnerItem->rclItem,CLR_RED);

                      break;
                      hptr=_wpQueryIcon(wpObject);
                      if(WinDrawPointer(pOwnerItem->hps, rcl.xLeft, rcl.yBottom, hptr, DP_NORMAL)) {
                        //DosBeep(500, 200);
                        cwDraw2ColorBorder(pOwnerItem->hps, &rclTemp, CLR_BLACK, CLR_DARKGRAY);
                        return (MRESULT) TRUE;
                      }
                    }
                  }
                }
#endif
                if(WinDrawPointer(pOwnerItem->hps, rcl.xLeft, rcl.yBottom, mrc->hptrIcon, DP_NORMAL)) {
                  //   WinDrawBorder(pOwnerItem->hps, &rclTemp, 3,3,0,0,0x400);
                  cwDraw2ColorBorder(pOwnerItem->hps, &rclTemp, CLR_BLACK, CLR_DARKGRAY);
                  return (MRESULT) TRUE;
                }
              }
          }/* mrc */
        }/* if(pOwnerItem->idItem==CMA_ICON) */
        else if(pOwnerItem->idItem==0) {
          /* It's the details view */
          PCNRDRAWITEMINFO pCnrDrawItemInfo=(PCNRDRAWITEMINFO)pOwnerItem->hItem;
          
          if(pCnrDrawItemInfo && pCnrDrawItemInfo->pFieldInfo->flData & CFA_BITMAPORICON) {
            PMINIRECORDCORE mrc=(PMINIRECORDCORE)((PCNRDRAWITEMINFO)pOwnerItem->hItem)->pRecord;
            if(mrc){
              WPObject *wpObjToRefresh;
              WPObject *wpObject;
              ULONG ulIconSize=150;/* Default if query fails */
              HWND hwndCnr=WinWindowFromID(hwnd, FID_CLIENT);
              RECTL rclTemp=pOwnerItem->rclItem;
              
              wpObjToRefresh=(WPObject*)OBJECT_FROM_PREC(mrc);//Get object
              wpObject=cwGetFileSystemObject(wpObjToRefresh);
              

              /* Draw Background */
              rclTemp.xLeft+=2;
              rclTemp.xRight-=2;
              rclTemp.yBottom+=2;
              rclTemp.yTop-=2;
              
              /* Check if record is selected */
              if((pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_INUSE)
                 && (pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_SELECTED)) {
                POINTL pointl;
                
                GpiSetPattern(pOwnerItem->hps,PATSYM_DIAG2);
                pointl.x = rclTemp.xLeft;
                pointl.y = rclTemp.yBottom;
                GpiMove(pOwnerItem->hps, &pointl);
                pointl.x = rclTemp.xRight - 1;
                pointl.y = rclTemp.yTop - 1;
                GpiSetColor(pOwnerItem->hps, CLR_BLACK);
                GpiBox(pOwnerItem->hps,DRO_FILL,&pointl,1,1);         
                
              }
              else if(pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_INUSE) {
                POINTL pointl;
                
                GpiSetPattern(pOwnerItem->hps,PATSYM_DIAG1);
                pointl.x = rclTemp.xLeft;
                pointl.y = rclTemp.yBottom;
                GpiMove(pOwnerItem->hps, &pointl);
                pointl.x = rclTemp.xRight - 1;
                pointl.y = rclTemp.yTop - 1;
                GpiSetColor(pOwnerItem->hps, CLR_BLACK);
                GpiBox(pOwnerItem->hps,DRO_FILL,&pointl,1,1);         
              }
              else if(pCnrDrawItemInfo->pRecord->flRecordAttr & CRA_SELECTED)
                WinFillRect(pOwnerItem->hps, &rclTemp, CLR_DARKGRAY);
              else
                WinFillRect(pOwnerItem->hps, &rclTemp, CLR_WHITE);

              if(somIsObj(wpObject)) {
                SOMClass* cwBitmapClass=queryCWBitmapFileClass();
                SOMClass* cwImageClass=queryCWImageFileClass();
                
                if(somIsObj(cwImageClass)||somIsObj(cwBitmapClass)) {
                  HBITMAP hbm=NULLHANDLE;
                  PBITMAPINFOHEADER2 pBmpInfoHeader2;
                  
                  /* Query object pointer */
                  if((hwndStore=WinWindowFromID(hwnd, STOREWINDOWID))!=NULLHANDLE)
                    {
                      somSelf=(MMFolder*) WinQueryWindowULong(hwndStore,QWL_USER);
                      if(somIsObj(somSelf)) {
                        MMFolderData *somThis = MMFolderGetData(somSelf); 
                        ulIconSize=_ulCurrentSize;
                      }
                    }
                  /* Get the small bitmap from the object */ 
                  if(_somIsA(wpObject, cwImageClass)) {
                    hbm=_cwmmQuerySmallBitmapHandle( (CWImage*) wpObject, ulIconSize, mrc, hwndCnr);
                    pBmpInfoHeader2=(PBITMAPINFOHEADER2)_wpQueryBitmapInfoHeader((CWImage*)wpObject);
                  }
                  else if(_somIsA(wpObject, cwBitmapClass)) {
                    hbm=_cwmmQuerySmallBitmapHandleCWBitmap( (CWImage*) wpObject, ulIconSize);
                    pBmpInfoHeader2=(PBITMAPINFOHEADER2)_wpQueryBitmapInfoHeader((CWBitmap*)wpObject);
                  }
                  if(hbm)
                    {
                      /* We got a small bitmap for display */
                      if(pBmpInfoHeader2) {
                        ULONG ulWidth, ulHeight;
                        ULONG ulIconHeight, ulIconWidth; /* size of drawing area on screen */
                        ULONG ulFact;
                        RECTL rcl=pOwnerItem->rclItem;
                        /* Get size of bitmap */
                        if(pBmpInfoHeader2->cbFix==sizeof(BITMAPINFOHEADER2)) {
                          ulWidth=pBmpInfoHeader2->cx;
                          ulHeight=pBmpInfoHeader2->cy;
                        }
                        else {
                          /* The default WPS bitmap class returned PBITMAPINFOHEADER */
                          PBITMAPINFOHEADER pBmpInfoHeader=(PBITMAPINFOHEADER)pBmpInfoHeader2;
                          ulWidth=pBmpInfoHeader->cx;
                          ulHeight=pBmpInfoHeader->cy;
                        }
                        /* Calculate size of drawing area */
                        ulIconHeight=rcl.yTop-rcl.yBottom;
                        ulIconWidth=rcl.xRight-rcl.xLeft;
                        //    writeLog("\nulIconHeight oS: %d w: %d h: %d\n", ulIconHeight, ulWidth, ulHeight);
                        /* Calculate scaling factor for bitmap so aspect ratio is kept */
                        ulFact=ulWidth>ulHeight ? ulWidth*1000/ulIconHeight : ulHeight*1000/ulIconHeight;
                        ulWidth=ulWidth*1000/ulFact;
                        ulHeight=ulHeight*1000/ulFact;
                        //writeLog2("ulFact: %d w: %d h: %d\n", ulFact, ulWidth, ulHeight);
                        /* Adjust x pos. Cx is greater than cy in details view. */
                        if(ulIconWidth>ulWidth)
                          rcl.xLeft+=(ulIconWidth-ulWidth)/2;
                        else {
                          ulWidth=ulIconWidth-2;
                          rcl.xLeft+=(ulIconWidth-ulWidth)/2;
                        }
                        rcl.xRight=rcl.xLeft+ulWidth;
                        /* Adjust y pos */
                        if(ulIconHeight>ulHeight)
                          rcl.yBottom+=(ulIconHeight-ulHeight)/2;
                        else {
                          ulHeight=ulIconHeight-2;
                          rcl.yBottom+=(ulIconHeight-ulHeight)/2;
                        }
                        rcl.yTop=rcl.yBottom+ulHeight;///ulFact;
                        
                        //     writeLog("New width/height: w: %d h: %d\n",  ulWidth, ulHeight);
                        //     writeLog("rcl: w: %d h: %d\n",  rcl.xRight-rcl.xLeft, rcl.yTop-rcl.yBottom);
                        /* And now draw the bitmap */
                        WinDrawBitmap(pOwnerItem->hps, hbm, NULL, (PPOINTL)&rcl,//pOwnerItem->rclItem,
                                      0,0,DBM_STRETCH);
                      }
                      return (MRESULT) TRUE;
                    }/* hbm */
                }/* cwImageClass */
              }/* wpObject*/
              /* It's not an image class. Draw normal pointer */
              if((ulIconSize=WinQuerySysValue(HWND_DESKTOP,SV_CXICON))!=0)
                {
                  ULONG ulWidth=ulIconSize;
                  ULONG ulHeight=ulIconSize;
                  ULONG ulIconWidth, ulIconHeight; /* size of drawing area on screen */
                  RECTL rcl=pOwnerItem->rclItem;
                  
                  /* Calculate size of drawing area */
                  ulIconHeight=rcl.yTop-rcl.yBottom;
                  ulIconWidth=rcl.xRight-rcl.xLeft;
                  
                  if(ulIconWidth>ulWidth)
                    rcl.xLeft+=(ulIconWidth-ulWidth)/2;
                  if(ulIconHeight>ulHeight)
                    rcl.yBottom+=(ulIconHeight-ulHeight)/2;
                  
                  if(WinDrawPointer(pOwnerItem->hps, rcl.xLeft, rcl.yBottom, mrc->hptrIcon, DP_NORMAL))
                    return (MRESULT) TRUE;
                }
            }/*  if(mrc) */
          }/* if(pCnrDrawItemInfo && pCnrDrawItemInfo->pFieldInfo->flData & CFA_BITMAPORICON) */
        }/* Details view */
        break;
      }
    case WM_INITMENU:
      if((hwndStore=WinWindowFromID(hwnd, STOREWINDOWID))!=NULLHANDLE)
        {
          somSelf=(MMFolder*) WinQueryWindowULong(hwndStore,QWL_USER);
          if(somIsObj(somSelf)) {
            MMFolderData *somThis = MMFolderGetData(somSelf); 
            switch(_usLastSelMenuItem)
              {
              case 0x2d1:/* view menu */
                {
                  char text[CCHMAXPATH];
                  MENUITEM mi;
                  HWND hwndMenu;
                  CNRINFO cnrInfo;

                  /* Insert size menu only in icon view */
                  if(WinSendMsg(WinWindowFromID(hwnd, FID_CLIENT),CM_QUERYCNRINFO, MPFROMP(&cnrInfo),
                                MPFROMSHORT(sizeof(cnrInfo)))) {

                    if((cnrInfo.flWindowAttr & CV_ICON) && !(cnrInfo.flWindowAttr & CV_TREE)) {
                      /* insert separator */
                      HlpInsertMenuSeparator(MIT_END, HWNDFROMMP(mp2), NULLHANDLE);
                      
                      /* Load the menu from the resource */
                      hwndMenu=WinLoadMenu(hwnd,queryModuleHandle(), ID_MENUICONSIZE);
                      
                      /* Fill the MENUITEM structure */
                      mi.iPosition=MIT_END;
                      mi.afStyle=MIS_TEXT|MIS_SUBMENU;
                      mi.id=ID_MENUICONSIZE;
                      mi.afAttribute=NULLHANDLE;                
                      mi.hwndSubMenu=hwndMenu;
                      mi.hItem=NULLHANDLE;
                      getMessage(text, IDSTR_ICONSIZEMENU, sizeof(text), queryModuleHandle(), hwnd);
                      HlpInsertMenuItem(MIT_END, HWNDFROMMP(mp2), hwndMenu, ID_MENUICONSIZE, text);
                      
                      /* check current menuitem */
                      switch(_ulCurrentSize)
                        {
                        case 0:
                          WinCheckMenuItem(hwndMenu, ID_NORMALICONSITEM, TRUE);
                          break;
                        case 50:
                          WinCheckMenuItem(hwndMenu, ID_50X50ITEM, TRUE);
                          break;
                        case 100:
                          WinCheckMenuItem(hwndMenu, ID_100X100ITEM, TRUE);
                          break;
                        case 150:
                          WinCheckMenuItem(hwndMenu, ID_150X150ITEM, TRUE);
                          break;
                        case 200:
                          WinCheckMenuItem(hwndMenu, ID_200X200ITEM, TRUE);
                          break;
                        case 250:
                          WinCheckMenuItem(hwndMenu, ID_250X250ITEM, TRUE);
                          break;
                        default:
                          break; 
                        }
                    }
                  }/* if() */
                  break;
                }/* case 0x2d1 */
              default:
                break;
              }
          }
        }
      break;
    case WM_MENUSELECT:
      if((hwndStore=WinWindowFromID(hwnd, STOREWINDOWID))!=NULLHANDLE)
        {
          somSelf=(MMFolder*) WinQueryWindowULong(hwndStore,QWL_USER);
          if(somIsObj(somSelf)) {
            MMFolderData *somThis = MMFolderGetData(somSelf); 
            _usLastSelMenuItem=SHORT1FROMMP(mp1);
          }
        }
      break;
    default:
      break;
    }
  /* Any other message is handled by the folder container procedure */
  if((hwndStore=WinWindowFromID(hwnd, STOREWINDOWID))!=NULLHANDLE)
    {
      somSelf=(MMFolder*) WinQueryWindowULong(hwndStore,QWL_USER);
      if(somIsObj(somSelf)) {
        MMFolderData *somThis = MMFolderGetData(somSelf); 
        if(_oldFrameProc)
          return _oldFrameProc(hwnd, msg, mp1, mp2);
      }
    }
    
  return WinDefWindowProc(hwnd, msg, mp1, mp2);
}


/*
 *	wpSetupOnce :override;
 */

SOM_Scope HWND  SOMLINK mmfldr_wpOpen(MMFolder *somSelf, HWND hwndCnr, 
                                      ULONG ulView, ULONG param)
{
  HWND hwnd;

  MMFolderData *somThis = MMFolderGetData(somSelf); 
    MMFolderMethodDebug("MMFolder","mmfldr_wpOpen");

    hwnd=(MMFolder_parent_WPFolder_wpOpen(somSelf, hwndCnr, 
                                            ulView, param));

    /* Only subclass folder frames, not settings notebooks */
    if(ulView!=OPEN_SETTINGS){    
      HWND hwndStore;

      if((hwndStore=WinCreateWindow(hwnd, WC_STATIC, "objectStore", 0, 0,0,0,0,
                         hwnd, HWND_BOTTOM, STOREWINDOWID, NULLHANDLE, NULLHANDLE))!=NULLHANDLE)
        {
          HWND hwndContainer;     

          WinSetWindowULong(hwndStore, QWL_USER, (ULONG)somSelf);
          _oldFrameProc=WinSubclassWindow(hwnd, mmFolderFrameProc);
          
          if(hwnd)
            {
              CNRINFO cnrInfo;
              HWND hwndContainer=WinWindowFromID(hwnd,FID_CLIENT);
              
              /* Change the containerflags */
              if(WinSendMsg(hwndContainer,CM_QUERYCNRINFO, MPFROMP(&cnrInfo),
                            MPFROMSHORT(sizeof(cnrInfo))))
                {
                  char text[200];

                  /*  sprintf(text, "ICONGRIDSIZE=%d;", _ulCurrentSize+20);
                      _wpSetup(somSelf, text); */
                  
                  if(cnrInfo.flWindowAttr & CV_ICON) {              
                    cnrInfo.slBitmapOrIcon.cx=_ulCurrentSize;
                    cnrInfo.slBitmapOrIcon.cy=_ulCurrentSize;
                    cnrInfo.flWindowAttr&=~CA_DRAWICON;
                    cnrInfo.flWindowAttr|=CA_DRAWBITMAP|CA_OWNERDRAW;
                    WinSendMsg(hwndContainer,CM_SETCNRINFO, MPFROMP(&cnrInfo),
                               MPFROMLONG(CMA_SLBITMAPORICON|CMA_FLWINDOWATTR));

                    //          WinPostMsg(WinWindowFromID(hwndFrame, FID_CLIENT),CM_ARRANGE, 0L,
                    //       0L);
                  }
                }
            }

          /* Subclass container */
          hwndContainer=WinWindowFromID(hwnd,FID_CLIENT);//Get container hwnd
          if(hwndContainer) {
            _oldContainerProc=WinSubclassWindow(hwndContainer, mmFolderContainerProc);
          }
        }
    }
    return hwnd;
}

#if 0
SOM_Scope BOOL  SOMLINK mmfldr_wpSetupOnce(MMFolder *somSelf, 
                                           PSZ pszSetupString)
{
  BOOL rc;

    MMFolderData *somThis = MMFolderGetData(somSelf);
    MMFolderMethodDebug("MMFolder","mmfldr_wpSetupOnce");

    rc=(MMFolder_parent_WPFolder_wpSetupOnce(somSelf, pszSetupString));

    if(_ulCurrentSize!=0 && _ulCurrentSize%50==0)
      {
        char setup[200];
        sprintf(setup, "ICONGRIDSIZE=%d;", _ulCurrentSize+15);
        _wpSetup(somSelf,setup);
      }

      _wpSetup(somSelf,"DETAILSCLASS=CWImage;ICONVIEW=GRIDDED;SORTCLASS=CWImage;");

    return rc;
}
#endif

SOM_Scope BOOL  SOMLINK mmfldr_wpRestoreState(MMFolder *somSelf, 
                                              ULONG ulReserved)
{
    MMFolderData *somThis = MMFolderGetData(somSelf);
    MMFolderMethodDebug("MMFolder","mmfldr_wpRestoreState");

    if(!_wpRestoreLong(somSelf, "MMFolder", KEY_ICONSIZE, &_ulCurrentSize)) {
      _ulCurrentSize=150;
    }

    return (MMFolder_parent_WPFolder_wpRestoreState(somSelf, 
                                                    ulReserved));
}

SOM_Scope BOOL  SOMLINK mmfldr_wpSaveState(MMFolder *somSelf)
{
    MMFolderData *somThis = MMFolderGetData(somSelf);
    MMFolderMethodDebug("MMFolder","mmfldr_wpSaveState");
    
    _wpSaveLong( somSelf, "MMFolder", KEY_ICONSIZE, _ulCurrentSize);

    return (MMFolder_parent_WPFolder_wpSaveState(somSelf));
}


SOM_Scope BOOL  SOMLINK mmfldr_wpMenuItemSelected(MMFolder *somSelf, 
                                                  HWND hwndFrame, 
                                                  ULONG ulMenuId)
{
  CNRINFO cnrInfo;

    MMFolderData *somThis = MMFolderGetData(somSelf);
    MMFolderMethodDebug("MMFolder","mmfldr_wpMenuItemSelected");

    if(ulMenuId>=0xbc01 && ulMenuId <=0xbc06) {
      HWND hwndContainer=WinWindowFromID(hwndFrame, FID_CLIENT);
      /* Change the containerflags */
      if(WinSendMsg(hwndContainer, CM_QUERYCNRINFO, MPFROMP(&cnrInfo),
                    MPFROMSHORT(sizeof(cnrInfo))))
        {
          char text[200];
          CNRINFO cnrInfo2=cnrInfo;
    
          switch(ulMenuId)
            {
            case ID_50X50ITEM:
              cnrInfo.slBitmapOrIcon.cx=50;
              break;
            case ID_100X100ITEM:
              cnrInfo.slBitmapOrIcon.cx=100;
              break;
            case ID_150X150ITEM:
              cnrInfo.slBitmapOrIcon.cx=150;
              break;
            case ID_200X200ITEM:
              cnrInfo.slBitmapOrIcon.cx=200;
              break;
            case ID_250X250ITEM:
              cnrInfo.slBitmapOrIcon.cx=250;
              break;
            default:
              cnrInfo.slBitmapOrIcon.cx=0;
              break;
            }

          _ulCurrentSize=cnrInfo.slBitmapOrIcon.cx;

          sprintf(text, "ICONGRIDSIZE=%d",cnrInfo.slBitmapOrIcon.cx+20);
          _wpSetup(somSelf, text);

          cnrInfo.slBitmapOrIcon.cy=cnrInfo.slBitmapOrIcon.cx;
          cnrInfo.flWindowAttr&=~CA_DRAWICON;
          cnrInfo.flWindowAttr|=CA_DRAWBITMAP|CA_OWNERDRAW;

          /* Prevent drawing in container */
          WinEnableWindowUpdate(hwndContainer, FALSE);

          cnrInfo2=cnrInfo;
          cnrInfo2.flWindowAttr=CV_DETAIL;
          WinSendMsg(hwndContainer,CM_SETCNRINFO, MPFROMP(&cnrInfo2),
                     MPFROMLONG(CMA_FLWINDOWATTR));

          WinSendMsg(hwndContainer,CM_SETCNRINFO, MPFROMP(&cnrInfo),
                     MPFROMLONG(CMA_SLBITMAPORICON|CMA_FLWINDOWATTR));

#if 0
          WinSendMsg(hwndContainer,CM_INVALIDATERECORD, 0L,
                     MPFROM2SHORT(0, CMA_REPOSITION));
#endif

     /* Prevent drawing in container */
          //          WinEnableWindowUpdate(hwndContainer, FALSE);

          //    _wpSetup(somSelf, "MENUITEMSELECTED=717");


     /* Prevent drawing in container */
          //          WinEnableWindowUpdate(hwndContainer, FALSE);

          //          bNot=TRUE;
          _wpSetup(somSelf, "MENUITEMSELECTED=716");
          //          WinEnableWindowUpdate(hwndContainer, TRUE);
          //     bNot=FALSE;
          _wpSetup(somSelf, "MENUITEMSELECTED=309");
     /* Prevent drawing in container */
          //          WinEnableWindowUpdate(hwndContainer, FALSE);



#if 0
          WinSendMsg(hwndContainer,CM_ARRANGE, 0L,
                     0L);
#endif
          WinEnableWindowUpdate(hwndContainer, TRUE);
          _wpSaveDeferred(somSelf);
          return TRUE;
        }
    }/* if() */
    return (MMFolder_parent_WPFolder_wpMenuItemSelected(somSelf, 
                                                        hwndFrame, 
                                                        ulMenuId));
}


/*
 *wpSetup:override;
 */

SOM_Scope void  SOMLINK mmfldr_wpObjectReady(MMFolder *somSelf, 
                                             ULONG ulCode, WPObject* refObject)
{
    MMFolderData *somThis = MMFolderGetData(somSelf);
    MMFolderMethodDebug("MMFolder","mmfldr_wpObjectReady");

    MMFolder_parent_WPFolder_wpObjectReady(somSelf, ulCode, refObject);

    //    DosBeep(5000, 500);
    switch(ulCode)
      {
      case OR_FROMTEMPLATE:
      case OR_NEW:
        //  DosBeep(500, 1500);
        if(_ulCurrentSize!=0 && _ulCurrentSize%50==0)
          {
            char setup[200];
            sprintf(setup, "ICONGRIDSIZE=%d;", _ulCurrentSize+15);
            _wpSetup(somSelf,setup);
          }
        _wpSetup(somSelf,"DETAILSCLASS=CWImage;ICONVIEW=GRIDDED;SORTCLASS=CWImage;DETAILSVIEW=NORMAL;DETAILSTODISPLAY=0,1,4,12,13,14,15;SORTBYATTR=6,24,25,26,27");
        break;
      default:
        break;
      }

}

/*
SOM_Scope BOOL  SOMLINK mmfldr_wpSetup(MMFolder *somSelf, PSZ pszSetupString)
{
    MMFolderData *somThis = MMFolderGetData(somSelf);
    MMFolderMethodDebug("MMFolder","mmfldr_wpSetup");

DosBeep(5000, 300);

    return (MMFolder_parent_WPFolder_wpSetup(somSelf, pszSetupString));
}
*/

SOM_Scope PSZ  SOMLINK mmfldrM_wpclsQueryTitle(M_MMFolder *somSelf)
{
  static char chrTitle[20]={0};
    /* M_MMFolderData *somThis = M_MMFolderGetData(somSelf); */
    M_MMFolderMethodDebug("M_MMFolder","mmfldrM_wpclsQueryTitle");

    if(chrTitle[0]==0)
      if(!getMessage(chrTitle, IDSTR_LIGHTTABLETITLE, sizeof(chrTitle), queryModuleHandle(), HWND_DESKTOP))
        strcpy(chrTitle,"Light table");

    return chrTitle;
}


SOM_Scope ULONG  SOMLINK mmfldrM_wpclsQueryIconData(M_MMFolder *somSelf, 
                                                    PICONINFO pIconInfo)
{
    /* M_MMFolderData *somThis = M_MMFolderGetData(somSelf); */
    M_MMFolderMethodDebug("M_MMFolder","mmfldrM_wpclsQueryIconData");

	if (pIconInfo)   {
      pIconInfo->fFormat = ICON_RESOURCE;
      pIconInfo->hmod    = queryModuleHandle();
      pIconInfo->resid   = ID_ICONLIGHTTABLE;
	} /* endif */

	return ( sizeof(ICONINFO) );
}


SOM_Scope ULONG  SOMLINK mmfldrM_wpclsQueryIconDataN(M_MMFolder *somSelf, 
                                                     ICONINFO* pIconInfo, 
                                                     ULONG ulIconIndex)
{
    /* M_MMFolderData *somThis = M_MMFolderGetData(somSelf); */
    M_MMFolderMethodDebug("M_MMFolder","mmfldrM_wpclsQueryIconDataN");

	if (pIconInfo)   {
      pIconInfo->fFormat = ICON_RESOURCE;
      pIconInfo->hmod    = queryModuleHandle();
      pIconInfo->resid   = ID_ICONLIGHTTABLE2;
	} /* endif */

	return ( sizeof(ICONINFO) );

    /*    return (M_MMFolder_parent_M_WPFolder_wpclsQueryIconDataN(somSelf, 
          pIconInfo, 
          ulIconIndex));*/
}

