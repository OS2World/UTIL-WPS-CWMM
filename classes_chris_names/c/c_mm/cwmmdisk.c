/*
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; see the file COPYING.  If not, write to
 * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
 */
/*
 * If you need another license for your project/product contact me at
 * 
 * http://www.os2world.com/cdwriting
 * http://www.geocities.com/SiliconValley/Sector/5785/
 */

/*
 *  This file was generated by the SOM Compiler and Emitter Framework.
 *  Generated using: 
 *      SOM Emitter emitctm: 2.42
 */

#ifndef SOM_Module_cwmmdisk_Source
#define SOM_Module_cwmmdisk_Source
#endif
#define CWMMDisk_Class_Source
#define M_CWMMDisk_Class_Source

#define INCL_PM
#define INCL_DOS
#define INCL_DOSERRORS
#define INCL_WINWORKPLACE


#include "os2.h"
#include <stdio.h>
#include "cwmmdisk.ih"
#include "wpobject.h"
#include "wpfolder.h"

extern int iFirstCD;
extern int iNumCD;
extern BOOL bGotCD;

HFILE openDrive(char* drive);
void closeDrive(HFILE hfDrive);
int CDQueryAudioCDTracks(HFILE hfDrive);

//#define OPEN_MMDISK  0x6500+0x400

SOM_Scope HWND  SOMLINK cwmmdisk_wpViewObject(CWMMDisk *somSelf, 
                                              HWND hwndCnr, ULONG ulView, 
                                              ULONG param)
{
   /* CWMMDiskData *somThis = CWMMDiskGetData(somSelf); */
    CWMMDiskMethodDebug("CWMMDisk","cwmmdisk_wpViewObject");

    if(ulView == OPEN_DETAILS || ulView ==  OPEN_CONTENTS || ulView == OPEN_TREE || ulView == OPEN_DEFAULT) {
      if(bGotCD) {
        int iDiskNum;
        
        if((iDiskNum=_wpQueryLogicalDrive(somSelf))!=0) {
          if((iDiskNum>=iFirstCD && iDiskNum<=iFirstCD+iNumCD)) {
            /* It's a CD drive */
            HOBJECT hObject;
            char chrPlayerID[100];
            ULONG ulRC;
            HFILE hFile;

            /* Check if it's an audio CD */
            sprintf(chrPlayerID, "%c:", 'A'+iDiskNum-1 );
            if((hFile=openDrive(chrPlayerID))!=NULLHANDLE) {
              int iNumTracks;
              iNumTracks=CDQueryAudioCDTracks( hFile);
              closeDrive(hFile);
              if(iNumTracks> 0) {
                sprintf(chrPlayerID, "<CWMM_CDPLAYER_%c>", 'A'+iDiskNum-1);
                if((hObject=WinQueryObject(chrPlayerID))!=NULLHANDLE) {
                  WPObject *wpObject;
                  HWND hwnd;
                  wpObject=_wpclsQueryObject( _CWMMDisk , hObject);
                  if(somIsObj(wpObject)) {
                    hwnd=_wpViewObject(wpObject, NULLHANDLE, OPEN_DEFAULT, 0);
                    _wpUnlockObject(wpObject);
                  }
                  return hwnd;
                }
              }
            }
          }
        }
      }
    }
    return (CWMMDisk_parent_WPDisk_wpViewObject(somSelf, hwndCnr, 
                                                ulView, param));
}

#if 0
SOM_Scope HWND  SOMLINK cwmmdisk_wpViewObject(CWMMDisk *somSelf, 
                                              HWND hwndCnr, ULONG ulView, 
                                              ULONG param)
{
   /* CWMMDiskData *somThis = CWMMDiskGetData(somSelf); */
    CWMMDiskMethodDebug("CWMMDisk","cwmmdisk_wpViewObject");

    if(ulView == OPEN_DETAILS || ulView ==  OPEN_CONTENTS || ulView == OPEN_TREE || ulView == OPEN_DEFAULT) {
      if(bGotCD) {
        int iDiskNum;
        
        if((iDiskNum=_wpQueryLogicalDrive(somSelf))!=0) {
          if((iDiskNum>=iFirstCD && iDiskNum<=iFirstCD+iNumCD)) {
            /* It's a CD drive */
            HOBJECT hObject;
            char chrPlayerID[100];
            ULONG ulRC;
            HFILE hFile;

            /* Check if it's an audio CD */
            sprintf(chrPlayerID, "%c:", 'A'+iDiskNum-1 );
            if((hFile=openDrive(chrPlayerID))!=NULLHANDLE) {
              int iNumTracks;
              iNumTracks=CDQueryAudioCDTracks( hFile);
              closeDrive(hFile);
              if(iNumTracks> 0) {
                sprintf(chrPlayerID, "<CWMM_CDPLAYER_%c>", 'A'+iDiskNum-1);
                
                if((hObject=WinQueryObject(chrPlayerID))!=NULLHANDLE) {
                  if((ulRC=WinOpenObject(hObject, OPEN_DEFAULT, TRUE))!=NULLHANDLE) {
#if 0
                    sprintf(chrPlayerID, "%d", ulRC);
                    WinMessageBox(HWND_DESKTOP,HWND_DESKTOP, chrPlayerID, "", 12324, MB_MOVEABLE);
#endif
                    return NULLHANDLE;}
                }
                /* For some strange reason WinOpenObject() returns 0 when the folder was already openend
                   by the user. If it's reopened using WinOpenObject() from this method it returns 1!?
                   We found the handle and tried to open it. Normally this succeeds so we just
                   proceed as if everything is ok. The only thing we might loose if opening wasn't
                   successful is the error box saying the CD isn't formatted properly (because it's an
                   audio CD). Most users will even not notice this difference ;-) */ 
                return NULLHANDLE;
              }
            }
          }
        }
      }
    }
    return (CWMMDisk_parent_WPDisk_wpViewObject(somSelf, hwndCnr, 
                                                ulView, param));
}
#endif

SOM_Scope PSZ  SOMLINK cwmmdiskM_wpclsQueryTitle(M_CWMMDisk *somSelf)
{
    /* M_CWMMDiskData *somThis = M_CWMMDiskGetData(somSelf); */
    M_CWMMDiskMethodDebug("M_CWMMDisk","cwmmdiskM_wpclsQueryTitle");

    return "CWMMDisk";
    /*    return (M_CWMMDisk_parent_M_WPDisk_wpclsQueryTitle(somSelf));*/
}

